(function e(t,n,r){function s(o,u){if(!n[o]){if(!t[o]){var a=typeof require=="function"&&require;if(!u&&a)return a(o,!0);if(i)return i(o,!0);var f=new Error("Cannot find module '"+o+"'");throw f.code="MODULE_NOT_FOUND",f}var l=n[o]={exports:{}};t[o][0].call(l.exports,function(e){var n=t[o][1][e];return s(n?n:e)},l,l.exports,e,t,n,r)}return n[o].exports}var i=typeof require=="function"&&require;for(var o=0;o<r.length;o++)s(r[o]);return s})({1:[function(require,module,exports){(function(global){"use strict";global.__base="/lib";window.titan={};(function(container){let App=require("./lib/App.js");let Compiler=require("./lib/compiler/Compiler.js");let View=require("./public/View.js");container.App=App;container.Compiler=Compiler;container.View=View})(window.titan)}).call(this,typeof global!=="undefined"?global:typeof self!=="undefined"?self:typeof window!=="undefined"?window:{})},{"./lib/App.js":2,"./lib/compiler/Compiler.js":3,"./public/View.js":40}],2:[function(require,module,exports){module.exports=class App{constructor(){let Fs=require("./fs/Main.js");this.fs=new Fs;this.device=null;this.sql=null}}},{"./fs/Main.js":24}],3:[function(require,module,exports){const View=require("../view/compiler/View.js");const Document=require("../dom/Document.js");module.exports=class Compiler{prepareDOM(datas,php,callback){let document=new Document;document.loadDOM(datas);this.prepare(document,php,callback)}prepare(document,php,callback){let view=new View;view.name="root";function prepare(view){view.onReady=function(){view.compile(php,function(result){callback(view,result)});Object.keys(view.views).map(k=>{prepare(view.views[k]);view.views[k].prepareChildren()})}}prepare(view);view.prepare(document.documentElement);view.prepareChildren()}}},{"../dom/Document.js":18,"../view/compiler/View.js":37}],4:[function(require,module,exports){module.exports=class Assignment{constructor(context,to,from,op,declare=true){this.context=context;this.to=to;this.from=from;this.op=op;this.declare=declare}toString(){return(this.declare&&!this.context.php?"let ":"")+this.to+" "+this.op+" "+this.from}}},{}],5:[function(require,module,exports){const _String=require("../type/_String.js");module.exports=class Call{constructor(context,ref,_arguments=[]){if(!Array.isArray(_arguments))throw new Error("Arguments must be in array");this.ref=ref;this.context=context;this.arguments=_arguments}call(name,_arguments){return this.context.call(this,name,_arguments)}toString(){let _arguments=this.arguments.map(o=>typeof o==="string"?this.context.string(o):o);return this.ref+"("+_arguments.join(", ")+")"}}},{"../type/_String.js":16}],6:[function(require,module,exports){module.exports=class Concat{constructor(context){this.context=context;this.content=[];this.isConcat=true}add(content){this.content.push(content)}toString(){return this.content.join(this.context.php?" . ":" + ")}}},{}],7:[function(require,module,exports){const Variable=require("./Variable.js");const _Class=require("./_Class.js");const Instanciate=require("./Instanciate.js");const Assignment=require("./Assignment.js");const Call=require("./Call.js");const Instruction=require("./Instruction.js");const Loop=require("./Loop.js");const Concat=require("./Concat.js");const _String=require("../type/_String.js");const Text=require("./Text.js");const Use=require("./Use.js");module.exports=class Context{constructor(parent,php){this.variables={};this.content=[];this.parent=parent;this.php=php}addVariable(name,_class){name=name||"var"+this.variables.length;let variable=_class?new _Class(this,name):new Variable(this,name);this.variables[name]=variable;return variable}getVariable(name){let result=this.variables[name];if(!result&&this.parent){result=this.parent.getVariable(name)}return result}context(){return new Context(this,this.php)}call(ref,method,_arguments){return new Call(this,ref+(this.php?"->":".")+method,_arguments)}assign(to,from,op="="){return this.instruct(new Assignment(this,to,from,op))}instanciate(_class,_arguments){return new Instanciate(this,_class,_arguments)}loop(property,content){return new Loop(this,property,content)}instruct(content){return new Instruction(this,content)}string(content){return new _String(this,content)}text(){return new Text(this,Object.keys(arguments).map(a=>arguments[a]))}use(content){this.add(new Use(this,content))}add(content){this.content.push(content)}render(){return this.content.join("")}}},{"../type/_String.js":16,"./Assignment.js":4,"./Call.js":5,"./Concat.js":6,"./Instanciate.js":8,"./Instruction.js":9,"./Loop.js":10,"./Text.js":11,"./Use.js":12,"./Variable.js":13,"./_Class.js":15}],8:[function(require,module,exports){module.exports=class Instanciate{constructor(context,ref,_arguments=[]){this.context=context;this.ref=ref;if(!Array.isArray(_arguments)){throw new Error("Arguments must be sent in array")}this.arguments=_arguments}toString(){return"new "+this.ref+"("+this.arguments.join(", ")+")"}}},{}],9:[function(require,module,exports){module.exports=class Instruction{constructor(context,content){this.context=context;this.content=content;this.isStructure=true}toString(){return this.content+";\n"}}},{}],10:[function(require,module,exports){module.exports=class Loop{constructor(context,ref,content){this.context=context.context();this.ref=ref;this.content=[];let item=this.context.addVariable("item");this.context.addVariable("key");this.context.tree=item;if(content)this.add(content)}add(content){this.content.push(content)}compile(){if(this.context.php){return["foreach (",this.ref," as $key => $item) {\n",this.content,"}"].join("")}else{return this.ref.call("forEach",[this.context.text("function(item, key) {\n  ",this.content,"}")])}}}},{}],11:[function(require,module,exports){module.exports=class Text{constructor(context,content){this.context=context;this.content=content;this.isStructure=true}toString(){return this.content.join("")}}},{}],12:[function(require,module,exports){module.exports=class Use{constructor(context,name){this.context=context;this.name=name}toString(){let name=this.name.replace(/\./g,"\\");return this.context.php?`use ${name};\n`:""}}},{}],13:[function(require,module,exports){const call=require("./Call.js");module.exports=class Variable{constructor(context,name){this.context=context;this.name=name}get(name){return new Variable(this.context,this.name+(this.context.php?"->":".")+name)}call(name,_arguments){return this.context.call(this,name,_arguments)}toString(){return this.context.php?"$"+this.name:this.name}}},{"./Call.js":5}],14:[function(require,module,exports){module.exports=class Window{constructor(php){this.php=php}render(){let dummy=this.context.getVariable("dummy");return[this.php?"":"(function(tree) {\n",this.context.render(),"return "+dummy.call("render")+";",this.php?"":"})(tree)\n"].join("")}}},{}],15:[function(require,module,exports){const Variable=require("./Variable.js");module.exports=class _Class extends Variable{toString(){return this.name}}},{"./Variable.js":13}],16:[function(require,module,exports){module.exports=class _String{constructor(context,content){this.context=context;this.content=[];if(content)this.add(content)}add(val){this.content.push(val)}run(){}compile(){return this}toString(){return"'"+this.content.join("")+"'"}}},{}],17:[function(require,module,exports){module.exports=class Attribute{constructor(document){this.type="attribute";this.document=document}toString(){return"@"+this.namespaceURI+":"+this.localName}}},{}],18:[function(require,module,exports){const Node=require("./Node.js");const Element=require("./Element.js");const Text=require("./Text.js");const Attribute=require("./Attribute.js");module.exports=class Document{constructor(parser){this.parser=parser}parse(content){if(!this.parser){const utils=require("../utils.js");if(utils.isBrowser()){this.parser=new DOMParser}else{throw new Error("No parser defined")}}let dom=this.parser.parseFromString(content,"text/xml");this.loadDOM(dom)}loadDOM(dom){let document=this;function loadText(datas){let text=new Text(document,datas.nodeValue);text.nodeName="#text";text.nodeValue=datas.nodeValue;return text}function loadAttribute(datas){let attr=new Attribute(document);attr.namespaceURI=datas.namespaceURI;attr.localName=datas.localName;attr.prefix=datas.prefix;attr.name=datas.name;attr.value=datas.nodeValue;return attr}function loadElement(datas){let el=new Element(document);el.namespaceURI=datas.namespaceURI;el.nodeName=datas.nodeName;el.localName=datas.localName;el.prefix=datas.prefix;el.name=datas.name;let children=[];if(datas.childNodes){let len=datas.childNodes.length;if(el.localName==="import"){console.log(children)}for(let i=0;i<len;i++){let sdatas=datas.childNodes[i];switch(sdatas.nodeType){case Node.TEXT:let val=sdatas.data.trim();if(val){children.push(loadText(sdatas))}break;case Node.ELEMENT:children.push(loadElement(sdatas));break;case Node.COMMENT:break;default:throw new Error("Unknown node type : "+sdatas.nodeType)}}}el.children=children;let attributes=[];if(datas.attributes){let len=datas.attributes.length;for(let i=0;i<len;i++){let attr=datas.attributes[i];if(attr.localName!=="xmlns"&&attr.prefix!=="xmlns"){attributes.push(loadAttribute(attr))}}}el.attributes=attributes;return el}var root=loadElement(dom.documentElement);this.documentElement=root;this.element=root}}},{"../utils.js":30,"./Attribute.js":17,"./Element.js":19,"./Node.js":20,"./Text.js":21}],19:[function(require,module,exports){const Node=require("./Node.js");module.exports=class Element extends Node{constructor(document){super(document);this.type=Node.ELEMENT}getAttribute(name){let result;let len=this.attributes.length;for(var key=0;key<len;key++){if(this.attributes[key].localName===name){result=this.attributes[key];break}}return result?result.value:""}read(){if(this.children.length>1||this.children[0].type!==Node.TEXT){throw new Error("Cannot read a complex element")}return this.children[0].value}toString(){return this.namespaceURI+":"+this.localName}}},{"./Node.js":20}],20:[function(require,module,exports){class Node{constructor(document){this.document=document}}Node.ELEMENT=1;Node.ATTRIBUTE=2;Node.TEXT=3;Node.COMMENT=8;module.exports=Node},{}],21:[function(require,module,exports){const Node=require("./Node.js");module.exports=class Text extends Node{constructor(document,value){super(document);this.type=Node.TEXT;this.value=value}toString(){return"#text:"+this.nodeValue}}},{"./Node.js":20}],22:[function(require,module,exports){},{}],23:[function(require,module,exports){module.exports=class File{constructor(path){this.path=path}open(callback){let utils=require("../utils.js");if(utils.isBrowser()){let xhttp=new XMLHttpRequest;xhttp.onreadystatechange=function(){if(this.readyState==4&&this.status==200){callback(this.responseText)}};xhttp.open("GET",this.path,true);xhttp.send()}else{let fs=require("fs");fs.readFile(this.path,"utf8",function(err,datas){callback(datas)})}}}},{"../utils.js":30,fs:39}],24:[function(require,module,exports){const Directory=require("../fs/Directory.js");const File=require("../fs/File.js");module.exports=class Main{constructor(){}getFile(path){return new File(path)}}},{"../fs/Directory.js":22,"../fs/File.js":23}],25:[function(require,module,exports){module.exports=class Collection{constructor(){}getStar(){return this.table}}},{}],26:[function(require,module,exports){module.exports=class Field{constructor(){}prepare(node){this.name=node.getAttribute("name")}}},{}],27:[function(require,module,exports){arguments[4][22][0].apply(exports,arguments)},{dup:22}],28:[function(require,module,exports){const Field=require("./Field.js");const Foreign=require("./Foreign.js");module.exports=class Table{constructor(){}parse(element){let el=element.children[0];this.name=el.getAttribute("name");let children=[];el.children.forEach(child=>{let result;switch(child.localName){case"field":result=new Field;result.prepare(child);break;case"foreign":result=new Foreign;result.prepare(child);break;default:throw new Error("Unknown table field : "+child)}children.push(result)});this.children=children}}},{"./Field.js":26,"./Foreign.js":27}],29:[function(require,module,exports){module.exports=class Select{constructor(){this.columns=[]}addElement(element){if(this.columns.indexOf(element)===-1){this.columns.push(element)}}compile(context){context.add(context.instruct(this.dummy.call("addElements",this.columns)))}}},{}],30:[function(require,module,exports){module.exports={isBrowser:function(){return typeof window!=="undefined"}}},{}],31:[function(require,module,exports){const Tree=require("./Tree");const Collection=require("../../sql/Collection.js");const Expression=require("./expression/Expression.js");module.exports=class Apply{constructor(context){this.context=context}prepare(node){this.select=node.getAttribute("select");this.mode=node.getAttribute("mode")}compile(context,tree,template){let expression=new Expression;let trees=expression.parse(tree,this.select);let result;trees.forEach(t=>{if(!t instanceof Tree){throw new Error("Not a tree")}});if(trees.length>1){throw new Error("Not implemented")}else{let childTree=!trees.length?tree:trees[0];template=template.view.lookupTemplate(childTree,this.mode);if(!template){if(this.required){throw new Error("No template found")}}else{if(tree instanceof Collection){let items=context.php?context.tree:context.tree.get("items");let loop=context.loop(items);loop.context.view=context.view;loop.add(template.compile(tree.table,loop.context));result=context.instruct(loop.compile())}else{throw new Error("Not implemented")}}}return result}}},{"../../sql/Collection.js":25,"./Tree":36,"./expression/Expression.js":38}],32:[function(require,module,exports){module.exports=class Element{constructor(template){this.template=template}prepare(node){this.name=node.localName;this.namespace=node.namespaceURI;this.prefix=node.prefix;this.children=this.template.parseChildren(node.children);this.attributes={};node.attributes.forEach(attribute=>this.attributes[attribute.name]=attribute.value)}run(parentElement){let element=window.document.createElement(this.getName());this.children.forEach(child=>element.insertChild(child.run()));parentElement.insertChild(element)}compile(context,tree,template){let content=[];let name=this.getName();content.push("<"+name);let attributes=Object.keys(this.attributes).map(key=>[key,this.attributes[key]]);attributes.forEach(attr=>content.push(" ",attr[0],'="',this.compileAttribute(attr[1]),'"'));let children=this.children.map(child=>typeof child==="string"?child:child.compile(context,tree,template));if(children.length){content.push(">");content.push.apply(content,children);content.push("</"+name+">")}else{content.push("/>")}return content}compileAttribute(value){return value}getName(){return(this.prefix?this.prefix+":":"")+this.name}}},{}],33:[function(require,module,exports){const Document=require("../../dom/Document.js");const File=require("../../fs/File.js");module.exports=class Import{constructor(view){this.view=view}prepare(node){let view=this.view;let path=node.read();let file=new File(path);view.addWait();file.open(content=>{if(!content){throw new Error("No content found")}let document=new Document(node.document.parser);document.parse(content);view.parseChildren(document.element.children);view.removeWait()})}}},{"../../dom/Document.js":18,"../../fs/File.js":23}],34:[function(require,module,exports){module.exports=class Read{constructor(template){this.template=template}prepare(node){this.path=node.getAttribute("select")}compile(context){context.view.tree.addElement(this.path);return context.php?context.tree.call("read",[this.path]):context.tree.get(this.path)}}},{}],35:[function(require,module,exports){const Node=require("../../dom/Node.js");const Element=require("./Element.js");const _String=require("../../compiler/type/_String.js");const Concat=require("../../compiler/language/Concat.js");module.exports=class Template{constructor(view){this.NS_HTML="http://2017.sylma.org/html";this.NS_TEMPLATE="http://2017.sylma.org/view";this.view=view;this.components={}}prepare(node){this.children=this.parseChildren(node.children);this.match=node.getAttribute("match");this.mode=node.getAttribute("mode")}compile(tree,context,callback){let content=this.children.map(child=>child.compile(context,tree,this));var result=this.buildContent(context,content);callback&&callback(result);return result}buildContent(context,content){function flatten(arr){return arr.reduce(function(flat,toFlatten){return flat.concat(Array.isArray(toFlatten)?flatten(toFlatten):toFlatten)},[])}content=flatten(content);content=content.filter(i=>i);let tree1=[];let k=0;let current=-1;let len=content.length;let isString=false;while(k<len){let val=content[k];let wasString=isString;let type=typeof val;isString=type==="string"||type==="number";if(val===undefined||val===null){throw new Error("Cannot set null value")}if(isString){if(!wasString)tree1[++current]=context.string();tree1[current].add(val)}else{tree1[++current]=val}k++}let tree2=[];k=0;current=0;len=tree1.length;isString=false;while(k<len){let val=tree1[k];let wasString=isString;isString=!val.isStructure;if(isString){if(!wasString)tree2[++current]=new Concat(context);tree2[current].add(val)}else{tree2[++current]=val}k++}let dummy=context.getVariable("dummy");return tree2.map(o=>o.isConcat?context.instruct(dummy.call("add",[o])):o).join("")}parseChildren(children){if(!children){return[]}let template=this;return children.map(child=>{if(child.type===Node.TEXT){let val=child.nodeValue.trim();return val}else if(child.data){return null}switch(child.namespaceURI){case template.NS_HTML:var element=new Element(template);element.prepare(child);return element;case template.NS_TEMPLATE:let _class;switch(child.localName){case"apply":_class=require("./Apply.js");break;case"read":_class=require("./Read.js");break;default:throw new Error("Unknown element")}let component=new _class;component.prepare(child);return component;default:throw new Error("Unknown namespace in "+child)}}).filter(i=>i)}}},{"../../compiler/language/Concat.js":6,"../../compiler/type/_String.js":16,"../../dom/Node.js":20,"./Apply.js":31,"./Element.js":32,"./Read.js":34}],36:[function(require,module,exports){const Document=require("../../dom/Document.js");const File=require("../../fs/File.js");const Table=require("../../sql/Table.js");const Query=require("../../sql/query/Select.js");const Window=require("../../compiler/language/Window.js");const Context=require("../../compiler/language/Context.js");const Collection=require("../../sql/Collection.js");module.exports=class Tree{constructor(view){this.view=view;this.elements=[]}prepare(node){let schema=node.getAttribute("schema");let view=this.view;let tree=this;if(schema){let file=new File(schema);view.addWait();file.open(content=>{if(!content){throw new Error("No content found")}tree.prepareWindow(content,node);view.removeWait()})}}addElement(element){this.query.addElement(element)}prepareWindow(content,node){let window=new Window;let context=new Context(window);window.name="tree";window.context=context;let publicQuery=context.addVariable("Query",true);let dummy=context.addVariable("dummy");this.view.windows.push(window);let document=new Document(node.document.parser);document.parse(content);let table=new Table;table.parse(document.documentElement);let collection=new Collection;collection.table=table;context.use("sylma.storage.sql.runtime.Query");context.add(context.assign(dummy,context.instanciate(publicQuery,[context.string(table.name)])));this.ref=collection;this.query=new Query;this.query.dummy=dummy;this.context=context}compile(php){this.context.php=php;this.context.parent.php=php;this.query.compile(this.context)}}},{"../../compiler/language/Context.js":7,"../../compiler/language/Window.js":14,"../../dom/Document.js":18,"../../fs/File.js":23,"../../sql/Collection.js":25,"../../sql/Table.js":28,"../../sql/query/Select.js":29}],37:[function(require,module,exports){const Tree=require("./Tree.js");const Template=require("./Template.js");const Import=require("./Import.js");const Context=require("../../compiler/language/Context.js");const Window=require("../../compiler/language/Window.js");const _Class=require("../../compiler/language/_Class.js");module.exports=class View{constructor(){this.children=[];this.templates=[];this.windows=[];this.views={};this.name="default";this.tree=null;this.awaited=0}prepare(element){this.element=element}prepareChildren(){let element=this.element;if(!element.children){throw new Error("Root must have children")}this.children=this.parseChildren(element.children);this.children=this.children.filter(i=>i);if(element.getAttribute("extends")){}if(!this.awaited){this.onReady()}}lookupTemplate(element,mode,root){let templates=this.templates.filter(t=>{t.weight=0;if(t.mode!==mode){return false}if(!t.match&&root){t.weight=2}else if(t.match==="*"){t.weight=1}return t.weight});templates.sort((a,b)=>a.weight<b.weight);return templates.length?templates[0]:null}onReady(){throw new Error("No callback defined on view")}addWait(){this.awaited++}removeWait(){this.awaited--;if(!this.awaited){this.onReady()}}run(){}compile(php,callback){let window=new Window(php);let context=new Context(window,php);window.context=context;window.name="main";this.windows.push(window);let view=context.addVariable("View",true);let dummy=context.addVariable("dummy");let scripts=context.addVariable("scripts");let tree=context.addVariable("tree");context.use("sylma.view.runtime.View");context.view=this;context.tree=tree;context.add(context.assign(dummy,context.instanciate(view,[scripts])));if(php){context.add(context.assign(tree,dummy.call("call",["tree"])))}let root=this.lookupTemplate(null,"",true);if(!root){throw new Error("Cannot find root template")}root.compile(this.tree.ref,context,result=>{context.add(result);this.tree.compile(php);this.windows.forEach(w=>w.content=w.render());callback(this.windows)})}parseChildren(children){return children.map(item=>this.parseChild(item))}parseChild(node){if(!node.nodeName||node.nodeName==="#text"){return;throw new Error("Child must be an element")}let result;switch(node.namespaceURI){case"http://2017.sylma.org/view":switch(node.localName){case"tree":result=new Tree(this);result.prepare(node);this.tree=result;break;case"import":result=new Import(this);result.prepare(node);break;case"template":result=new Template(this);result.prepare(node);this.templates.push(result);break;case"view":result=new View(this);result.prepare(node);if(this.views[result.name]){throw new Error("One or more view share the same name : "+result.name)}this.views[result.name]=result;break;default:throw new Error(`Unknown element name : ${node.nodeName}`)}break;default:throw new Error(`Unknown element namespace : ${node.nodeName}`)}return result}}},{"../../compiler/language/Context.js":7,"../../compiler/language/Window.js":14,"../../compiler/language/_Class.js":15,"./Import.js":33,"./Template.js":35,"./Tree.js":36}],38:[function(require,module,exports){module.exports=class Expression{constructor(){}parse(tree,content){let result=this.parsePath(tree,content);return[result]}parsePath(tree,content){let result=tree;if(content==="*"){result=tree.getStar()}else{let content=content.split(".");while(content.length){result=result.getElement(content.shift())}}return result}parseGroups(content){let i=0;let l=content.length;let opened=0;let Unknown=new Class;{construct();{this.unknown=true;this.content=[]}}let result=[];let current;while(i<l){let c=content[i];if(c==="("){let previous=current;opened.push(previous);current=new Group;previous.content.push(current)}else if(c===")"){current=opened.pop()}else{if(!current){current=new Unknown;result.push(current)}current.content.push(c)}i++}}parseStrings(path){let i=0;let l=path.length;let open=true;let result=[];let k=-1;while(i<l){let c=path[i];if(c==="'"){if(!i||path[i-1]!=="\\"){if(open){result.push(new _String)}else{result.push("")}k++;open=!open}}else{if(open)result[k]+=c;else result[k].content+=c}i++}}}},{}],39:[function(require,module,exports){},{}],40:[function(require,module,exports){module.exports=class View{constructor(){this.content=""}get(path){console.log("get "+path)}add(content){this.content+=content}render(){return this.content}}},{}]},{},[1]);
