(function e(t,n,r){function s(o,u){if(!n[o]){if(!t[o]){var a=typeof require=="function"&&require;if(!u&&a)return a(o,!0);if(i)return i(o,!0);var f=new Error("Cannot find module '"+o+"'");throw f.code="MODULE_NOT_FOUND",f}var l=n[o]={exports:{}};t[o][0].call(l.exports,function(e){var n=t[o][1][e];return s(n?n:e)},l,l.exports,e,t,n,r)}return n[o].exports}var i=typeof require=="function"&&require;for(var o=0;o<r.length;o++)s(r[o]);return s})({1:[function(require,module,exports){"use strict";window.titan={};(function(container){let Compiler=require("./lib/compiler/Compiler.js");let View=require("./lib/view/public/View.js");container.Compiler=Compiler;container.View=View})(window.titan)},{"./lib/compiler/Compiler.js":2,"./lib/view/public/View.js":19}],2:[function(require,module,exports){const Context=require("./language/Context.js");const View=require("../view/compiler/View.js");module.exports=class Compiler{prepare(document){let context=new Context;let view=new View;view.prepare(document.documentElement);let result=view.compile(context);return result}}},{"../view/compiler/View.js":18,"./language/Context.js":6}],3:[function(require,module,exports){module.exports=class Assignment{constructor(context,to,from,op,declare=true){this.context=context;this.to=to;this.from=from;this.op=op;this.declare=declare}toString(){return(this.declare?"let ":"")+this.to+" "+this.op+" "+this.from}}},{}],4:[function(require,module,exports){const _String=require("../type/String.js");module.exports=class Call{constructor(context,ref,_arguments=[]){if(!Array.isArray(_arguments))throw new Error("Arguments must be in array");this.ref=ref;this.context=context;this.arguments=_arguments}call(name,_arguments){return this.context.call(this,name,_arguments)}toString(){let _arguments=this.arguments.map(o=>typeof o==="string"?new _String(o):o);return this.ref+"("+_arguments.join(", ")+")"}}},{"../type/String.js":12}],5:[function(require,module,exports){module.exports=class Concat{constructor(context){this.context=context;this.content=[];this.isConcat=true}add(content){this.content.push(content)}toString(){return this.content.join(" + ")}}},{}],6:[function(require,module,exports){const Variable=require("./Variable.js");const Instanciate=require("./Instanciate.js");const Assignment=require("./Assignment.js");const Call=require("./Call.js");const Instruction=require("./Instruction.js");const Loop=require("./Loop.js");const Concat=require("./Concat.js");const Text=require("./Text.js");module.exports=class Context{constructor(parent){this.variables={};this.content=[];this.parent=parent}addVariable(name){name=name||"var"+this.variables.length;let variable=new Variable(this,name);this.variables[name]=variable;return variable}getVariable(name){let result=this.variables[name];if(!result&&this.parent){result=this.parent.getVariable(name)}return result}context(){return new Context(this)}call(ref,method,_arguments){return new Call(this,ref+"."+method,_arguments)}assign(to,from,op="="){return this.instruct(new Assignment(this,to,from,op))}instanciate(_class,_arguments){return new Instanciate(this,_class,_arguments)}loop(property,content){return new Loop(this,property,content)}instruct(content){return new Instruction(this,content)}text(){return new Text(this,Object.keys(arguments).map(a=>arguments[a]))}add(content){this.content.push(content)}render(){return this.content.join("")}}},{"./Assignment.js":3,"./Call.js":4,"./Concat.js":5,"./Instanciate.js":7,"./Instruction.js":8,"./Loop.js":9,"./Text.js":10,"./Variable.js":11}],7:[function(require,module,exports){module.exports=class Instanciate{constructor(context,ref,_arguments=[]){this.context=context;this.ref=ref;this.arguments=_arguments}toString(){return"new "+this.ref+"("+this.arguments.join(", ")+")"}}},{}],8:[function(require,module,exports){module.exports=class Instruction{constructor(context,content){this.context=context;this.content=content;this.isStructure=true}toString(){return this.content+";\n"}}},{}],9:[function(require,module,exports){module.exports=class Loop{constructor(context,ref,content){this.context=context.context();this.ref=ref;this.content=[];let item=this.context.addVariable("item");this.context.addVariable("key");this.context.tree=item;if(content)this.add(content)}add(content){this.content.push(content)}compile(){return this.ref.call("forEach",[this.context.text("function(item, key) {\n  ",this.content,"}")])}}},{}],10:[function(require,module,exports){module.exports=class Text{constructor(context,content){this.context=context;this.content=content;this.isStructure=true}toString(){return this.content.join("")}}},{}],11:[function(require,module,exports){const call=require("./Call.js");module.exports=class Variable{constructor(context,name){this.context=context;this.name=name}get(name){return new Variable(this.context,this.name+"."+name)}call(name,_arguments){return this.context.call(this,name,_arguments)}toString(){return this.name}}},{"./Call.js":4}],12:[function(require,module,exports){module.exports=class _String{constructor(content){this.content=[];if(content)this.add(content)}add(val){this.content.push(val)}run(){}compile(){return this}toString(){return"'"+this.content.join("")+"'"}}},{}],13:[function(require,module,exports){module.exports=class Apply{constructor(context){this.context=context}prepare(node){this.path=node.getAttribute("select");this.mode=node.getAttribute("mode")}compile(context,template){template=template.view.lookupTemplate(this.mode)[0];let loop=context.loop(context.tree.get(this.path));loop.add(template.compile(loop.context));return context.instruct(loop.compile())}}},{}],14:[function(require,module,exports){module.exports=class Element{constructor(template){this.template=template}prepare(node){this.name=node.localName;this.namespace=node.namespaceURI;this.prefix=node.prefix;this.children=this.template.parseChildren(node.childNodes);this.attributes={};if(node.attributes){let len=node.attributes.length;for(var i=0;i<len;i++){var attribute=node.attributes[i];this.attributes[attribute.nodeName]=attribute.nodeValue}}}run(parentElement){let element=window.document.createElement(this.getName());this.children.forEach(child=>element.insertChild(child.run()));parentElement.insertChild(element)}compile(context,template){let content=[];let name=this.getName();content.push("<"+name);let attributes=Object.keys(this.attributes).map(key=>[key,this.attributes[key]]);attributes.forEach(attr=>content.push(" ",attr[0],'="',this.compileAttribute(attr[1]),'"'));let children=this.children.map(child=>typeof child==="string"?child:child.compile(context,template));if(children.length){content.push(">");content.push.apply(content,children);content.push("</"+name+">")}else{content.push("/>")}return content}compileAttribute(value){return value}getName(){return(this.prefix?this.prefix+":":"")+this.name}}},{}],15:[function(require,module,exports){module.exports=class Read{constructor(template){this.template=template}prepare(node){this.path=node.getAttribute("select")}compile(context){return context.tree.get(this.path)}}},{}],16:[function(require,module,exports){const Element=require("./Element.js");const _String=require("../../compiler/type/String.js");const Concat=require("../../compiler/language/Concat.js");module.exports=class Template{constructor(view){this.NS_HTML="http://2017.sylma.org/html";this.NS_TEMPLATE="http://2017.sylma.org/view";this.view=view;this.components={}}prepare(node){this.children=this.parseChildren(node.childNodes);this.mode=node.getAttribute("mode")}compile(context){let content=this.children.map(child=>child.compile(context,this));return this.compileContent(context,content)}compileContent(context,content){function flatten(arr){return arr.reduce(function(flat,toFlatten){return flat.concat(Array.isArray(toFlatten)?flatten(toFlatten):toFlatten)},[])}content=flatten(content);content=content.filter(i=>i);let tree1=[];let k=0;let current=-1;let len=content.length;let isString=false;while(k<len){let val=content[k];let wasString=isString;let type=typeof val;isString=type==="string"||type==="number";if(val===undefined||val===null){throw new Error("Cannot set null value")}if(isString){if(!wasString)tree1[++current]=new _String;tree1[current].add(val)}else{tree1[++current]=val}k++}let tree2=[];k=0;current=0;len=tree1.length;isString=false;while(k<len){let val=tree1[k];let wasString=isString;isString=!val.isStructure;if(isString){if(!wasString)tree2[++current]=new Concat(context);tree2[current].add(val)}else{tree2[++current]=val}k++}let dummy=context.getVariable("dummy");return tree2.map(o=>o.isConcat?context.instruct(dummy.call("add",[o])):o).join("")}parseChildren(content){if(!content){return[]}let template=this;let len=content.length;let children=[];for(var i=0;i<len;i++){children.push(content[i])}return children.map(child=>{if(child.nodeName==="#text"){let val=child.nodeValue.trim();return val}else if(child.data){return null}switch(child.namespaceURI){case template.NS_HTML:var element=new Element(template);element.prepare(child);return element;case template.NS_TEMPLATE:let _class;switch(child.localName){case"apply":_class=require("./Apply.js");break;case"read":_class=require("./Read.js");break;default:throw new Error("Unknown element")}let component=new _class;component.prepare(child);return component;default:throw new Error("Unknown namespace in "+child)}}).filter(i=>i)}}},{"../../compiler/language/Concat.js":5,"../../compiler/type/String.js":12,"./Apply.js":13,"./Element.js":14,"./Read.js":15}],17:[function(require,module,exports){module.exports=class Tree{prepare(node){}run(){}compile(){}}},{}],18:[function(require,module,exports){const Tree=require("./Tree.js");const Template=require("./Template.js");module.exports=class View{constructor(){this.templates=[]}prepare(element){if(!element.childNodes){throw new Error("Root must have children")}this.children=Object.keys(element.childNodes).map(item=>this.parseChild(element.childNodes[item]));this.children=this.children.filter(i=>i)}lookupTemplate(mode){return this.templates.filter(t=>t.mode===mode)}run(){}compile(context){let view=context.addVariable("View");let dummy=context.addVariable("dummy");let tree=context.addVariable("tree");context.tree=tree;context.add(context.text("(function(tree) {\n"));context.add(context.assign(dummy,context.instanciate(view)));context.add(this.templates[0].compile(context));context.add(context.text("return "+dummy+"; })(tree)"));return context.render()}parseChild(node){if(!node.nodeName||node.nodeName==="#text"){return;throw new Error("Child must be an element")}let result;switch(node.namespaceURI){case"http://2017.sylma.org/view":switch(node.localName){case"tree":result=new Tree;result.prepare(node);break;case"template":result=new Template(this);result.prepare(node);this.templates.push(result);break;default:throw new Error(`Unknown element name : ${node.nodeName}`)}break;default:throw new Error(`Unknown element namespace : ${node.nodeName}`)}return result}}},{"./Template.js":16,"./Tree.js":17}],19:[function(require,module,exports){module.exports=class View{constructor(){this.content=""}get(path){console.log("get "+path)}add(content){this.content+=content}}},{}]},{},[1]);
