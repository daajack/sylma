<?xml version="1.0" encoding="utf-8"?>
<tst:tests
  xmlns:tst="http://www.sylma.org/modules/tester/parser"
  xmlns:html="http://www.w3.org/1999/xhtml"
  xmlns:view="http://2013.sylma.org/view"
  xmlns:tpl="http://2013.sylma.org/template"
  xmlns:stp="http://2013.sylma.org/schema/template"
  xmlns:sql="http://2013.sylma.org/storage/sql"
  xmlns:ls="http://2013.sylma.org/parser/security"
  xmlns:le="http://2013.sylma.org/action"

  xmlns:user="http://2013.sylma.org/view/test/sample1"
  xmlns:group="http://2013.sylma.org/view/test/sample2"
>
  <tst:description>Reference</tst:description>
  <tst:test name="Simple reference">
    <tst:document>
      <view:view user:ns="ns" group:ns="ns">
        <sql:resource>
          <sql:id>1</sql:id>
        </sql:resource>
        <view:schema>samples/group2.xql</view:schema>
        <view:template>
          <div>
            <h3><stp:apply select="name"/></h3>
            <ul>
              <tpl:apply select="users/ref()"/>
            </ul>
          </div>
        </view:template>
        <view:template match="user:user2">
          <li><tpl:read select="name"/></li>
        </view:template>
      </view:view>
    </tst:document>
    <tst:node>
      <div>
        <h3>group01</h3>
        <ul>
          <li>admin</li>
          <li>user1</li>
        </ul>
      </div>
    </tst:node>
  </tst:test>
  <tst:test name="Join">
    <tst:document>
      <view:view user:ns="ns" group:ns="ns">
        <sql:resource multiple="x">
          <sql:id>1</sql:id>
        </sql:resource>
        <view:schema>samples/group2.xql</view:schema>
        <tpl:template>
          <div>
            <tpl:apply select="*"/>
          </div>
        </tpl:template>
        <view:template match="group:group">
          <h2><tpl:read select="name"/></h2>
          <tpl:apply select="users/join()"/>
        </view:template>
        <view:template match="user:user2">
          <li><tpl:read select="name"/></li>
        </view:template>
      </view:view>
    </tst:document>
    <tst:node>
      <div>
        <h2>group01</h2>
        <li>admin</li>
        <h2>group01</h2>
        <li>user1</li>
      </div>
    </tst:node>
  </tst:test>
  <tst:test name="Simple filter">
    <tst:document>
      <view:view user:ns="ns" group:ns="ns">
        <sql:resource>
          <sql:id>1</sql:id>
        </sql:resource>
        <view:schema>samples/group2.xql</view:schema>
        <view:template>
          <div>
            <h3><stp:apply select="name"/></h3>
            <ul>
              <tpl:apply select="users/ref()"/>
            </ul>
          </div>
        </view:template>
        <view:template match="user:user2">
          <sql:filter name="name">admin</sql:filter>
          <li><tpl:read select="name"/></li>
        </view:template>
      </view:view>
    </tst:document>
    <tst:node>
      <div>
        <h3>group01</h3>
        <ul>
          <li>admin</li>
        </ul>
      </div>
    </tst:node>
  </tst:test>
  <tst:test name="View form">
    <tst:document>
      <view:view user:ns="ns">
        <sql:resource>
          <sql:id>1</sql:id>
        </sql:resource>
        <view:schema>samples/group2.xql</view:schema>
        <view:template>
          <div>
            <tpl:apply select="name,users"/>
          </div>
        </view:template>
        <view:template match="user:user2">
          <tpl:apply select="name"/>
        </view:template>
        <view:template match="sql:reference" sql:ns="ns">
          <fieldset>
            <tpl:apply select="ref()"/>
          </fieldset>
        </view:template>
        <view:template match="*">
          <input name="{alias('form')}" value="{value()}"/>
          <tpl:register/>
        </view:template>
      </view:view>
    </tst:document>
    <tst:node>
      <div>
        <input name="name" value="group01"/>
        <fieldset>
          <input name="users[0][name]" value="admin"/>
          <input name="users[1][name]" value="user1"/>
        </fieldset>
      </div>
    </tst:node>
  </tst:test>
  <tst:test name="Form insert">
    <tst:document>
      <view:view user:ns="ns">
        <sql:resource>
          <sql:id>3</sql:id>
        </sql:resource>
        <view:schema>samples/group2.xql</view:schema>
        <view:template>
          <div>
            <tpl:apply select="name,users"/>
          </div>
        </view:template>
        <view:template match="user:user2">
          <tpl:apply select="name"/>
        </view:template>
        <view:template match="sql:reference" sql:ns="ns">
          <fieldset>
            <tpl:apply select="static()"/>
          </fieldset>
        </view:template>
        <view:template match="*">
          <input name="{alias('form')}"/>
          <tpl:register/>
        </view:template>
      </view:view>
    </tst:document>
    <tst:node>
      <div>
        <input name="name"/>
        <fieldset>
          <input name="users[][name]"/>
        </fieldset>
      </div>
    </tst:node>
  </tst:test>
</tst:tests>